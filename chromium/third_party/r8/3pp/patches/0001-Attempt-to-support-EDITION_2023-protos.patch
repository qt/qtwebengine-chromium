From e8a04e0ddf89d62510471897d25586db948e6e89 Mon Sep 17 00:00:00 2001
From: Andrew Grieve <agrieve@google.com>
Date: Thu, 9 May 2024 17:38:24 -0400
Subject: [PATCH] Attempt to support EDITION_2023 protos

---
 .../ir/analysis/proto/schema/ProtoFieldType.java | 16 ++++++++--------
 .../proto/schema/ProtoOneOfFieldType.java        |  6 +++---
 2 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoFieldType.java b/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoFieldType.java
index b6ec3b300b..aca9712909 100644
--- a/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoFieldType.java
+++ b/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoFieldType.java
@@ -31,7 +31,7 @@ public class ProtoFieldType {
   private final boolean isRequired;
   private final boolean enforceUtf8Mask;
   private final boolean needsIsInitializedCheck;
-  private final boolean isMapFieldWithProto2EnumValue;
+  private final boolean isLegacyEnumClosedBit;
   private final boolean hasHasBit;
 
   ProtoFieldType(
@@ -39,13 +39,13 @@ public class ProtoFieldType {
       boolean isRequired,
       boolean enforceUtf8Mask,
       boolean needsIsInitializedCheck,
-      boolean isMapFieldWithProto2EnumValue,
+      boolean isLegacyEnumClosedBit,
       boolean hasHasBit) {
     this.id = id;
     this.isRequired = isRequired;
     this.enforceUtf8Mask = enforceUtf8Mask;
     this.needsIsInitializedCheck = needsIsInitializedCheck;
-    this.isMapFieldWithProto2EnumValue = isMapFieldWithProto2EnumValue;
+    this.isLegacyEnumClosedBit = isLegacyEnumClosedBit;
     this.hasHasBit = hasHasBit;
     assert isValid();
   }
@@ -98,8 +98,8 @@ public class ProtoFieldType {
     return id == MAP_ID;
   }
 
-  public boolean isMapFieldWithProto2EnumValue() {
-    return isMapFieldWithProto2EnumValue;
+  public boolean isLegacyEnumClosedBit() {
+    return isLegacyEnumClosedBit;
   }
 
   public boolean isMessage() {
@@ -147,9 +147,9 @@ public class ProtoFieldType {
       case ENUM_ID:
       case ENUM_LIST_ID:
       case ENUM_LIST_PACKAGED_ID:
-        return BooleanUtils.intValue(isProto2) + 1;
+        return BooleanUtils.intValue(isProto2 || isLegacyEnumClosedBit) + 1;
       case MAP_ID:
-        return BooleanUtils.intValue(isMapFieldWithProto2EnumValue) + 2;
+        return BooleanUtils.intValue(isLegacyEnumClosedBit) + 2;
       default:
         return 1;
     }
@@ -166,7 +166,7 @@ public class ProtoFieldType {
     if (needsIsInitializedCheck) {
       result |= FIELD_NEEDS_IS_INITIALIZED_CHECK_MASK;
     }
-    if (isMapFieldWithProto2EnumValue) {
+    if (isLegacyEnumClosedBit) {
       result |= FIELD_IS_MAP_FIELD_WITH_PROTO_2_ENUM_VALUE_MASK;
     }
     if (hasHasBit) {
diff --git a/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoOneOfFieldType.java b/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoOneOfFieldType.java
index 1bc2ab5e99..a0f79b86fe 100644
--- a/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoOneOfFieldType.java
+++ b/src/main/java/com/android/tools/r8/ir/analysis/proto/schema/ProtoOneOfFieldType.java
@@ -15,14 +15,14 @@ public class ProtoOneOfFieldType extends ProtoFieldType {
       boolean isRequired,
       boolean enforceUtf8Mask,
       boolean needsIsInitializedCheck,
-      boolean isMapFieldWithProto2EnumValue,
+      boolean isLegacyEnumClosedBit,
       boolean hasHasBit) {
     super(
         id,
         isRequired,
         enforceUtf8Mask,
         needsIsInitializedCheck,
-        isMapFieldWithProto2EnumValue,
+        isLegacyEnumClosedBit,
         hasHasBit);
   }
 
@@ -69,7 +69,7 @@ public class ProtoOneOfFieldType extends ProtoFieldType {
       case GROUP_ID:
         return 1;
       case ENUM_ID:
-        return BooleanUtils.intValue(isProto2);
+        return BooleanUtils.intValue(isProto2 || isLegacyEnumClosedBit());
       default:
         return 0;
     }
-- 
2.45.0.118.g7fe29c98d7-goog

